<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Scorte Emergenza</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/locale/it.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/timezone.js"></script>
  <script>dayjs.locale("it");
      dayjs.extend(window.dayjs_plugin_utc);
      dayjs.extend(window.dayjs_plugin_timezone);</script>
  <style>
    @media print {
      body * {
        visibility: hidden;
      }
      #printableArea, #printableArea * {
        visibility: visible;
      }
      #printableArea {
        -webkit-print-color-adjust: exact;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 15mm; /* Aggiungi un po' di margine per la stampa */
        box-sizing: border-box; /* Include padding nel calcolo della larghezza */
        color: black; /* Assicura testo nero per la stampa */
        background-color: white; /* Assicura sfondo bianco per la stampa */
      }
       /* Stili specifici per le tabelle stampate */
       #printableArea table {
           border-collapse: collapse;
           width: 100%;
           margin-top: 1rem;
           margin-bottom: 1rem; /* Aggiunto margine inferiore */
           font-size: 10pt; /* Dimensione testo tabella */
       }
       #printableArea th, #printableArea td {
           border: 1px solid #ccc;
           padding: 8px;
           text-align: left;
       }
       #printableArea th {
           background-color: #f2f2f2;
       }
       #printableArea ul {
           list-style: disc;
           margin-left: 1.5rem;
           margin-bottom: 1rem; /* Aggiunto margine inferiore */
           font-size: 10pt; /* Dimensione testo lista */
       }
       #printableArea h1, #printableArea h2, #printableArea h3, #printableArea h4 {
           margin-bottom: 0.5rem;
           color: black; /* Assicura colore nero */
       }
        #printableArea p {
            font-size: 10pt; /* Dimensione testo paragrafo */
            margin-bottom: 0.5rem;
            color: black; /* Assicura colore nero */
        }
         /* Assicura che i div bg-gray-50 o simili non abbiano sfondi che nascondano il testo */
        #printableArea .bg-gray-50 {
            background-color: white !important;
        }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="flex justify-between items-center bg-white p-4 shadow mb-4">
    <div id="currentDate" class="text-lg"></div>
    <div id="clock" class="text-2xl font-mono"></div>      
    <div id="worldClocks" class="flex gap-4 text-sm md:text-base"></div>
  </header>
  <div id="app" class="container mx-auto p-4"></div>
  <div id="printableArea" class="hidden"></div> <script type="module">
    import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@7/+esm';

    const defaultDevices = [
      'Radio a manovella o solare',
      'Coltello multiuso o multi-tool',
      'Cavi e adattatori USB',
      'Coperte termiche d’emergenza',
      'Fischietto di segnalazione',
      'Guanti da lavoro e mascherine antipolvere',
      'Kit di pronto soccorso avanzato',
      'Estintore portatile',
      'Lampada frontale',
      'Power bank solare',
      'GPS portatile o PLB',
      'Caricabatterie a pannello solare',
      'Tenda impermeabile/poncho'
    ];

    // Dati per le scorte mediche comuni (basati su ricerca)
    const commonMedicalSupplies = {
        "Seleziona un sintomo": [],
        "Gastroenterite (diarrea/vomito)": [
            "Sali reidratanti orali (soluzione elettrolitica)",
            "Farmaci antidiarroici (solo per adulti, con cautela)",
            "Farmaci anti-nausea/anti-vomito (con cautela)",
            "Acqua in bottiglia/purificata",
            "Cibi leggeri (crackers, riso in bianco, banane)",
            "Termometro"
        ],
        "Ferite lievi / Tagli / Abrasioni": [
            "Disinfettante cutaneo (es. clorexidina, iodopovidone)",
            "Garze sterili",
            "Cerotti di varie dimensioni",
            "Bende (elastiche o di garza)",
            "Nastro adesivo medicale",
            "Guanti monouso",
            "Pomata antibiotica/cicatrizzante (uso locale)",
            "Acqua ossigenata o soluzione fisiologica per pulizia"
        ],
        "Febbre / Dolore": [
            "Termometro",
            "Farmaci antipiretici/analgesici (es. Paracetamolo, Ibuprofene - verifica dosaggi)",
            "Coperte termiche",
            "Liquidi (acqua, tisane)"
        ],
        "Scottature lievi / Eritemi solari": [
            "Acqua fresca (per raffreddare)",
            "Garze sterili non aderenti",
            "Pomata per scottature (es. a base di sulfadiazina argentica per lievi ustioni, o creme lenitive per eritemi)",
            "Antidolorifici (se necessario)"
        ],
         "Reazioni allergiche lievi (es. punture insetti)": [
            "Antistaminici orali",
            "Crema cortisonica/antistaminica (uso locale)",
            "Ghiaccio istantaneo o impacchi freddi",
            "Pinzette (per rimuovere pungiglioni)"
         ]
        // Aggiungere altri sintomi comuni e relativi rimedi se necessario
    };


    // Aumentato il versionamento del DB
    const dbPromise = openDB('emergency-supplies', 4, {
      upgrade(db) {
        if (!db.objectStoreNames.contains('scenarios'))
          db.createObjectStore('scenarios', { keyPath: 'id', autoIncrement: true });
        if (!db.objectStoreNames.contains('lists')) {
          const store = db.createObjectStore('lists', { keyPath: 'id', autoIncrement: true });
          store.createIndex('scenario', 'scenario');
        }
        if (!db.objectStoreNames.contains('items')) {
          const store = db.createObjectStore('items', { keyPath: 'id', autoIncrement: true });
          store.createIndex('listId', 'listId');
          store.createIndex('insertDate', 'insertDate');
          store.createIndex('expiration', 'expiration');
        }
        if (!db.objectStoreNames.contains('devices')) {
          const store = db.createObjectStore('devices', { keyPath: 'id', autoIncrement: true });
          store.createIndex('isDefault', 'isDefault');
        }
        if (!db.objectStoreNames.contains('files'))
          db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
        // Nuovo object store per i calcoli salvati
        if (!db.objectStoreNames.contains('savedCalculations'))
          db.createObjectStore('savedCalculations', { keyPath: 'id', autoIncrement: true });
      }
    });

    async function initDB() {
      const db = await dbPromise;
      if (await db.count('scenarios') === 0) {
        for (const name of ['blackout','guerra','pandemia','terremoto'])
          await db.add('scenarios', { name });
      }
      if (await db.count('devices') === 0) {
        for (const name of defaultDevices)
          await db.add('devices', { name, isDefault: true });
      }
    }

    function renderHeader() {
  const dateEl = document.getElementById('currentDate');
  const clockEl = document.getElementById('clock');
  const worldClocksEl = document.getElementById('worldClocks');
  const fixedDate = dayjs('2025-05-03');
  function update() {
    dateEl.textContent = fixedDate.format('dddd D MMMM YYYY');
    clockEl.textContent = dayjs().format('HH:mm:ss');
    const ny   = dayjs().tz('America/New_York').format('HH:mm:ss');
    const tokyo= dayjs().tz('Asia/Tokyo').format('HH:mm:ss');
    const dc   = dayjs().tz('America/New_York').format('HH:mm:ss');
    worldClocksEl.innerHTML = `
      <span class="font-medium">New&nbsp;York: ${ny}</span>
      <span class="font-medium">Tokyo: ${tokyo}</span>
      <span class="font-medium">Washington: ${dc}</span>`;
  }
  update();
  setInterval(update, 1000);
}


    function renderUI() {
      document.getElementById('app').innerHTML = `
        <div class="bg-white p-4 rounded shadow mb-4">
          <h2 class="font-semibold mb-2">Tipologie di scenari</h2>
          <ul class="list-disc ml-6">
            <li><strong>Blackout:</strong> nessuna elettricità, +20% acqua</li>
            <li><strong>Guerra:</strong> rischi sanitari, +30% farmaci</li>
            <li><strong>Pandemia:</strong> limitazione contatti, +50% dispositivi medici</li>
            <li><strong>Terremoto:</strong> danni strutturali, +40% utensili</li>
          </ul>
        </div>

        <div class="flex gap-4 mb-4">
          <button id="openOutbagModal" class="px-4 py-2 bg-blue-600 text-white rounded">Crea Out-Bag</button>
          <button id="openDevicesModal" class="px-4 py-2 bg-indigo-600 text-white rounded">Gestisci Dispositivi</button>
           <button id="openSavedCalculationsModal" class="px-4 py-2 bg-green-600 text-white rounded">Calcoli Salvati</button> </div>

        <div id="outbagModal" role="dialog" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
          <div class="bg-white p-6 rounded shadow w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Nuova Out-Bag</h3>
            <input id="outbagName" type="text" placeholder="Nome Out-Bag" class="border p-2 rounded w-full mb-2" aria-label="Nome Out-Bag">
            <select id="outbagScenario" class="border p-2 rounded w-full mb-2"></select>
            <input id="outbagAdults" type="number" placeholder="Adulti" class="border p-2 rounded w-full mb-2" aria-label="Numero di adulti per l'Out-Bag">
            <input id="outbagChildren" type="number" placeholder="Bambini ≤12 anni" class="border p-2 rounded w-full mb-2" aria-label="Numero di bambini per l'Out-Bag">
            <div class="flex justify-end gap-2">
              <button id="cancelOutbag" class="px-4 py-2 bg-gray-300 rounded">Annulla</button>
              <button id="saveOutbag" class="px-4 py-2 bg-blue-600 text-white rounded">Salva</button>
            </div>
          </div>
        </div>

        <div id="devicesModal" role="dialog" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
          <div class="bg-white p-6 rounded shadow w-full max-w-md max-h-[80vh] overflow-auto">
            <h3 class="text-lg font-semibold mb-4">Gestione Dispositivi</h3>
            <div class="flex gap-2 mb-4">
              <input id="newDeviceName" type="text" placeholder="Dispositivo personale" class="border p-2 rounded flex-1" aria-label="Nome dispositivo personale">
              <button id="addDeviceBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Aggiungi</button>
            </div>
            <div id="devicesList" class="space-y-2 mb-4"></div>
            <div class="flex justify-end">
              <button id="closeDevices" class="px-4 py-2 bg-gray-300 rounded">Chiudi</button>
            </div>
          </div>
        </div>

        <div id="savedCalculationsModal" role="dialog" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
          <div class="bg-white p-6 rounded shadow w-full max-w-md max-h-[80vh] overflow-auto">
            <h3 class="text-lg font-semibold mb-4">Calcoli Salvati</h3>
            <div id="savedCalculationsList" class="space-y-4"></div>
            <div class="flex justify-end mt-4">
              <button id="closeSavedCalculations" class="px-4 py-2 bg-gray-300 rounded">Chiudi</button>
            </div>
          </div>
        </div>


        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="md:col-span-4 bg-white p-4 rounded shadow"> <h2 class="text-xl font-semibold mb-2">Nuova Lista di Scorte</h2>
            <input type="text" id="newListName" placeholder="Nome lista" class="border p-2 rounded w-full mb-2" aria-label="Nome lista">
            <select id="newListScenario" class="border p-2 rounded w-full mb-2"></select>
            <button id="newListBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Crea Lista</button>
          </div>

           <div class="bg-white p-4 rounded shadow md:col-span-1"> <h2 class="text-xl font-semibold mb-2">Liste di Scorte</h2>
            <div id="lists"></div>
          </div>

          <div class="bg-white p-4 rounded shadow md:col-span-1"> <h2 class="text-xl font-semibold mb-2">Dispositivi per Emergenze</h2>
            <div id="devicesSummary" class="space-y-2"></div>
          </div>

          <div class="bg-white p-4 rounded shadow md:col-span-1"> <h2 class="text-xl font-semibold mb-2">Calcolatore Scorte Alimentari/Idriche</h2>
            <input type="number" id="peopleInput" placeholder="Adulti" class="w-full mb-2 p-2 border rounded" aria-label="Numero di adulti">
            <input type="number" id="childrenInput" placeholder="Bambini" class="w-full mb-2 p-2 border rounded" aria-label="Numero di bambini">
            <input type="number" id="daysInput" placeholder="Giorni" class="w-full mb-2 p-2 border rounded" aria-label="Numero di giorni">
            <select id="scenarioSelectCalc" class="w-full mb-2 p-2 border rounded"></select>
            <div class="flex gap-2">
              <button id="calcBtn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded">Calcola</button>
              <button id="saveCalcBtn" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded hidden">Salva Calcolo</button> </div>
            <div id="calcResult" class="mt-4"></div>
          </div>
           <div class="bg-white p-4 rounded shadow md:col-span-1"> <h2 class="text-xl font-semibold mb-2">Scorte Mediche Consigliate per Sintomi Comuni</h2>
             <p class="text-sm mb-4">Seleziona un sintomo comune per vedere le scorte mediche consigliate in una situazione di emergenza.</p>
             <select id="medicalConditionSelect" class="w-full mb-4 p-2 border rounded"></select>
             <div id="medicalSuppliesResult" class="mt-4"></div>
           </div>


          <div class="md:col-span-4 bg-white p-4 rounded shadow"> <h2 class="text-xl font-semibold mb-2">Documenti e Immagini</h2>
            <p class="text-sm mb-2">Tipi ammessi: PDF, PNG, JPG, JPEG, GIF.</p>
            <input type="file" id="fileInput" multiple accept="image/*,application/pdf" class="mb-2" aria-label="Carica file">
            <div id="files" class="space-y-2"></div>
          </div>
        </div>
      `;

      // Listeners
      document.getElementById('openOutbagModal').addEventListener('click', () => document.getElementById('outbagModal').classList.remove('hidden'));
      document.getElementById('cancelOutbag').addEventListener('click', () => document.getElementById('outbagModal').classList.add('hidden'));
      document.getElementById('saveOutbag').addEventListener('click', saveOutbag);
      document.getElementById('openDevicesModal').addEventListener('click', () => document.getElementById('devicesModal').classList.remove('hidden'));
      document.getElementById('closeDevices').addEventListener('click', () => document.getElementById('devicesModal').classList.add('hidden'));
      document.getElementById('addDeviceBtn').addEventListener('click', addDevice);
      document.getElementById('newListBtn').addEventListener('click', addNewList);
      document.getElementById('calcBtn').addEventListener('click', calculateSupplies);
      document.getElementById('saveCalcBtn').addEventListener('click', saveCalculation); // Listener per Salva Calcolo
      document.getElementById('openSavedCalculationsModal').addEventListener('click', () => { // Listener per aprire modale calcoli salvati
        document.getElementById('savedCalculationsModal').classList.remove('hidden');
        loadSavedCalculations();
      });
      document.getElementById('closeSavedCalculations').addEventListener('click', () => document.getElementById('savedCalculationsModal').classList.add('hidden')); // Listener per chiudere modale calcoli salvati
       document.getElementById('medicalConditionSelect').addEventListener('change', displayMedicalSupplies); // Listener per il nuovo selettore
      document.getElementById('fileInput').addEventListener('change', handleFileUpload);


      // Initial load
      initMedicalSuppliesDropdown(); // Inizializza il nuovo selettore
      loadScenarios();
      loadDevices();
      renderLists();
      loadFiles();
    }

    async function loadScenarios() {
      const scens = await (await dbPromise).getAll('scenarios');
      const opts = scens.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
      document.getElementById('newListScenario').innerHTML = opts;
      document.getElementById('outbagScenario').innerHTML = opts;
      document.getElementById('scenarioSelectCalc').innerHTML = opts; // Carica scenari anche per il calcolatore
    }

    async function addNewList() {
      const name = document.getElementById('newListName').value.trim();
      const scenario = document.getElementById('newListScenario').value;
      if (!name) return alert('Inserisci nome lista');
      await (await dbPromise).add('lists', { name, scenario });
      document.getElementById('newListName').value = '';
      renderLists();
    }

    async function addDevice() {
      const name = document.getElementById('newDeviceName').value.trim();
      if (!name) return alert('Inserisci dispositivo');
      await (await dbPromise).add('devices', { name, isDefault: false });
      document.getElementById('newDeviceName').value = '';
      loadDevices();
    }

    async function saveOutbag() {
      const name = document.getElementById('outbagName').value.trim();
      const scenario = document.getElementById('outbagScenario').value;
      const adults = +document.getElementById('outbagAdults').value;
      const children = +document.getElementById('outbagChildren').value;
      if (!name) return alert('Inserisci nome Out-Bag');
       if (adults < 0 || children < 0) return alert('Numero adulti/bambini non valido'); // Validazione aggiunta

      await (await dbPromise).add('lists', { name, scenario, type: 'outbag', adults, children });
      document.getElementById('outbagModal').classList.add('hidden');
      renderLists();
    }

    async function loadDevices() {
      const devices = await (await dbPromise).getAll('devices');
      const list = document.getElementById('devicesList'); list.innerHTML = '';
      const summaryEl = document.getElementById('devicesSummary'); summaryEl.innerHTML = '';
      const defaults = devices.filter(d => d.isDefault).map(d => d.name);
      defaults.forEach(name => {
        const box = document.createElement('div');
        box.className = 'border rounded p-2 mb-2';
        box.textContent = name;
        summaryEl.appendChild(box);
      });
      devices.forEach(d => {
        const wrapper = document.createElement('div'); wrapper.className = 'flex justify-between items-center border rounded p-2';
        const span = document.createElement('span'); span.textContent = d.name;
        wrapper.append(span);
        if (!d.isDefault) {
          const btn = document.createElement('button'); btn.textContent = 'Elimina'; btn.className = 'px-2 py-1 bg-red-600 text-white rounded text-sm';
          btn.addEventListener('click', async () => {
            if (confirm('Eliminare dispositivo?')) { // Conferma eliminazione
              await (await dbPromise).delete('devices', d.id); loadDevices();
            }
          });
          wrapper.append(btn);
        }
        list.appendChild(wrapper);
      });
    }

    async function renderLists() {
      const lists = await (await dbPromise).getAll('lists');
      const container = document.getElementById('lists'); container.innerHTML = '';
      lists.forEach(list => {
        const div = document.createElement('div'); div.className = 'bg-gray-50 p-3 rounded shadow mb-2';
        const title = list.name + (list.type === 'outbag' ? ` (Out-Bag: ${list.adults} Adulti, ${list.children} Bambini)` : ''); // Dettaglio Out-Bag
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div><h3 class="font-semibold">${title}</h3><span class="text-sm">${list.scenario}</span></div>
            <div class="flex gap-2"> <button data-id="${list.id}" class="print-list-btn px-2 py-1 bg-teal-600 text-white rounded">Stampa Lista</button> <button data-id="${list.id}" class="delete-list-btn px-2 py-1 bg-red-600 text-white rounded">Elimina</button>
            </div>
          </div>
          <table class="w-full text-sm mt-2">
            <thead><tr><th>Voce</th><th>Qta</th><th>Data</th><th>Scadenza</th><th>Azioni</th></tr></thead>
            <tbody id="items-${list.id}"></tbody>
          </table>
          <button data-id="${list.id}" class="add-item-btn mt-2 px-3 py-1 bg-blue-600 text-white rounded">Aggiungi Voce</button>
        `;
        container.appendChild(div);
        div.querySelector('.delete-list-btn').addEventListener('click', async () => {
          if (confirm('Eliminare lista?')) {
            await (await dbPromise).delete('lists', list.id);
            renderLists();
          }
        });
         div.querySelector('.print-list-btn').addEventListener('click', () => printList(list.id)); // Listener Stampa
        div.querySelector('.add-item-btn').addEventListener('click', () => showAddItemForm(list.id));
        renderItems(list.id);
      });
    }

    async function renderItems(listId) {
      const items = await (await dbPromise).getAllFromIndex('items', 'listId', listId);
      const tbody = document.getElementById(`items-${listId}`); tbody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td>${dayjs(item.insertDate).format('DD/MM/YYYY')}</td>
          <td>${item.expiration ? dayjs(item.expiration).format('DD/MM/YYYY') : '-'}</td>
          <td><button data-id="${item.id}" class="delete-item-btn px-1 py-1 bg-red-600 text-white rounded">Elimina</button></td>
        `;
        tbody.appendChild(tr);
        tr.querySelector('.delete-item-btn').addEventListener('click', async () => {
          if (confirm('Eliminare elemento?')) {
            await (await dbPromise).delete('items', item.id);
            renderItems(listId);
          }
        });
      });
    }

    function showAddItemForm(listId) {
      const name = prompt('Nome elemento:'); if (!name) return;
      const quantity = prompt('Quantità:');
      if (quantity === null || quantity.trim() === '' || isNaN(quantity)) return alert('Quantità non valida'); // Validazione quantità

      const expInput = prompt('Scadenza (DD/MM/YYYY) vuoto se no:');
      let expiration = null;
      if (expInput) {
        const parts = expInput.split('/');
        if (parts.length === 3) {
          const [d, m, y] = parts;
           // Validazione e parsing data migliorati
          const date = dayjs(`${y}-${m}-${d}`);
          if(date.isValid()) expiration = date.toISOString();
          else alert('Formato data non valido. Usare DD/MM/YYYY.');
        } else {
           // Tentativo di parsing con dayjs per altri formati, con avviso se non valido
           const date = dayjs(expInput);
           if(date.isValid()) expiration = date.toISOString();
           else alert('Formato data non valido.');
        }
      }
      const insertDate = new Date().toISOString();
       if(expiration !== undefined) { // Procedi solo se la data è valida o vuota
         dbPromise.then(db => db.add('items', { listId, name, quantity: +quantity, expiration, insertDate })) // Converti quantity in numero
           .then(() => renderItems(listId));
       }
    }

    function calculateSupplies() {
      const adults = +document.getElementById('peopleInput').value;
      const children = +document.getElementById('childrenInput').value;
      const days = +document.getElementById('daysInput').value;
      const scenario = document.getElementById('scenarioSelectCalc').value;

      if ((!adults && !children) || !days || adults < 0 || children < 0 || days < 1) { // Validazione completa
        return alert('Inserisci un numero valido di adulti, bambini e giorni (almeno 1 giorno).');
      }

      const perAdult = { water: 3, pasta: 200, bread: 200, crackers: 100, rice: 150, driedMeat: 100, farmaci: 0, utensili: 0, dispositivi_medici: 0 }; // Inizializza con 0
      const perChild = { water: 2, pasta: 150, bread: 150, crackers: 75, rice: 100, driedMeat: 75, farmaci: 0, utensili: 0, dispositivi_medici: 0 }; // Inizializza con 0


       // Moltiplicatori come oggetti per accesso più pulito
      const multipliers = {
          'blackout': { water: 1.2, farmaci: 1, utensili: 1, dispositivi_medici: 1 },
          'guerra': { water: 1, farmaci: 1.3, utensili: 1, dispositivi_medici: 1 },
          'pandemia': { water: 1, farmaci: 1, utensili: 1, dispositivi_medici: 1.5 },
          'terremoto': { water: 1, farmaci: 1, utensili: 1.4, dispositivi_medici: 1 }
       };

      const currentMultiplier = multipliers[scenario] || {}; // Prendi i moltiplicatori per lo scenario, fallback a oggetto vuoto

      const adultDaily = {
        water: Math.round(perAdult.water * (currentMultiplier.water || 1)), // Applica moltiplicatore acqua
        pasta: perAdult.pasta,
        bread: perAdult.bread,
        crackers: perAdult.crackers,
        rice: perAdult.rice,
        meat: perAdult.driedMeat,
         farmaci: Math.round(perAdult.farmaci * (currentMultiplier.farmaci || 1)), // Applica moltiplicatore farmaci
         utensili: Math.round(perAdult.utensili * (currentMultiplier.utensili || 1)), // Applica moltiplicatore utensili
         dispositivi_medici: Math.round(perAdult.dispositivi_medici * (currentMultiplier.dispositivi_medici || 1)) // Applica moltiplicatore dispositivi medici

      };
      const childDaily = {
        water: Math.round(perChild.water * (currentMultiplier.water || 1)), // Applica moltiplicatore acqua
        pasta: perChild.pasta,
        bread: perChild.bread,
        crackers: perChild.crackers,
        rice: perChild.rice,
        meat: perChild.driedMeat,
         farmaci: Math.round(perChild.farmaci * (currentMultiplier.farmaci || 1)), // Applica moltiplicatore farmaci
         utensili: Math.round(perChild.utensili * (currentMultiplier.utensili || 1)), // Applica moltiplicatore utensili
         dispositivi_medici: Math.round(perChild.dispositivi_medici * (currentMultiplier.dispositivi_medici || 1)) // Applica moltiplicatore dispositivi medici
      };

      const adultTotal = {}, childTotal = {}, combinedTotal = {}; // Aggiunto combinedTotal

      Object.keys(adultDaily).forEach(key => {
        adultTotal[key] = adultDaily[key] * days * adults; // Totale adulti per tipo
        childTotal[key] = childDaily[key] * days * children; // Totale bambini per tipo
         combinedTotal[key] = adultTotal[key] + childTotal[key]; // Totale combinato
      });


      const resultHTML = `
        <div class="bg-gray-50 p-3 rounded">
          <h4 class="font-semibold mb-2">Scorte giornaliere per persona</h4>
          <p><strong>Adulto:</strong> Acqua ${adultDaily.water} L, Pasta ${adultDaily.pasta} g, Pane ${adultDaily.bread} g, Crackers ${adultDaily.crackers} g, Riso ${adultDaily.rice} g, Carne ${adultDaily.meat} g
          ${adultDaily.farmaci > 0 ? `, Farmaci ${adultDaily.farmaci} unità` : ''}
          ${adultDaily.utensili > 0 ? `, Utensili ${adultDaily.utensili} unità` : ''}
          ${adultDaily.dispositivi_medici > 0 ? `, Dispositivi Medici ${adultDaily.dispositivi_medici} unità` : ''}</p>
          <p><strong>Bambino:</strong> Acqua ${childDaily.water} L, Pasta ${childDaily.pasta} g, Pane ${childDaily.bread} g, Crackers ${childDaily.crackers} g, Riso ${childDaily.rice} g, Carne ${childDaily.meat} g
           ${childDaily.farmaci > 0 ? `, Farmaci ${childDaily.farmaci} unità` : ''}
           ${childDaily.utensili > 0 ? `, Utensili ${childDaily.utensili} unità` : ''}
           ${childDaily.dispositivi_medici > 0 ? `, Dispositivi Medici ${childDaily.dispositivi_medici} unità` : ''}</p>


          <h4 class="font-semibold mt-2">Totali per ${days} giorni</h4>
          <ul class="list-disc ml-6">
            <li>Acqua: Adulti ${adultTotal.water} L, Bambini ${childTotal.water} L, **Totale: ${combinedTotal.water} L**</li>
            <li>Pasta: Adulti ${adultTotal.pasta} g, Bambini ${childTotal.pasta} g, **Totale: ${combinedTotal.pasta} g**</li>
            <li>Pane: Adulti ${adultTotal.bread} g, Bambini ${childTotal.bread} g, **Totale: ${combinedTotal.bread} g**</li>
            <li>Crackers: Adulti ${adultTotal.crackers} g, Bambini ${childTotal.crackers} g, **Totale: ${combinedTotal.crackers} g**</li>
            <li>Riso: Adulti ${adultTotal.rice} g, Bambini ${childTotal.rice} g, **Totale: ${combinedTotal.rice} g**</li>
            <li>Carne: Adulti ${adultTotal.meat} g, Bambini ${childTotal.meat} g, **Totale: ${combinedTotal.meat} g**</li>
             ${combinedTotal.farmaci > 0 ? `<li>Farmaci: **Totale: ${combinedTotal.farmaci} unità (stima)**</li>` : ''}
             ${combinedTotal.utensili > 0 ? `<li>Utensili: **Totale: ${combinedTotal.utensili} unità (stima)**</li>` : ''}
             ${combinedTotal.dispositivi_medici > 0 ? `<li>Dispositivi Medici: **Totale: ${combinedTotal.dispositivi_medici} unità (stima)**</li>` : ''}
          </ul>
        </div>`;

      document.getElementById('calcResult').innerHTML = resultHTML;
       document.getElementById('saveCalcBtn').classList.remove('hidden'); // Mostra il pulsante Salva Calcolo dopo il calcolo
    }

    async function saveCalculation() {
        const adults = +document.getElementById('peopleInput').value;
        const children = +document.getElementById('childrenInput').value;
        const days = +document.getElementById('daysInput').value;
        const scenario = document.getElementById('scenarioSelectCalc').value;
        const resultHTML = document.getElementById('calcResult').innerHTML; // Salva l'HTML del risultato

         if (!resultHTML || resultHTML.trim() === '') return alert('Esegui prima un calcolo da salvare.'); // Controlla se c'è un risultato valido

        const calculationData = {
            timestamp: new Date().toISOString(),
            adults: adults,
            children: children,
            days: days,
            scenario: scenario,
            resultHTML: resultHTML,
            name: `Calcolo ${dayjs().format('YYYY-MM-DD HH:mm')}` // Nome predefinito per il calcolo salvato
        };

        await (await dbPromise).add('savedCalculations', calculationData);
        alert('Calcolo salvato!');
         document.getElementById('saveCalcBtn').classList.add('hidden'); // Nasconde il pulsante dopo il salvataggio
    }

    async function loadSavedCalculations() {
        const calculations = await (await dbPromise).getAll('savedCalculations');
        const container = document.getElementById('savedCalculationsList');
        container.innerHTML = ''; // Pulisci la lista corrente

        if (calculations.length === 0) {
            container.innerHTML = '<p>Nessun calcolo salvato.</p>';
            return;
        }

        // Ordina i calcoli dal più recente al meno recente
        calculations.sort((a, b) => dayjs(b.timestamp).valueOf() - dayjs(a.timestamp).valueOf());


        calculations.forEach(calc => {
            const div = document.createElement('div');
            div.className = 'bg-gray-100 p-3 rounded shadow';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold">${calc.name}</h4> <div class="flex gap-2">
                        <button data-id="${calc.id}" class="print-calc-btn px-2 py-1 bg-teal-600 text-white rounded text-sm">Stampa</button> <button data-id="${calc.id}" class="delete-calc-btn px-2 py-1 bg-red-600 text-white rounded text-sm">Elimina</button>
                    </div>
                </div>
                <p class="text-sm">Persone: ${calc.adults} Adulti, ${calc.children} Bambini | Giorni: ${calc.days} | Scenario: ${calc.scenario}</p>
                <div class="mt-2">${calc.resultHTML}</div> `;
            container.appendChild(div);

            div.querySelector('.delete-calc-btn').addEventListener('click', async () => {
                 if(confirm('Eliminare questo calcolo salvato?')) {
                    await (await dbPromise).delete('savedCalculations', calc.id);
                    loadSavedCalculations(); // Ricarica la lista dopo l'eliminazione
                 }
            });
             div.querySelector('.print-calc-btn').addEventListener('click', () => printCalculation(calc.id)); // Listener Stampa Calcolo
        });
    }

     async function printCalculation(calculationId) {
        const db = await dbPromise;
        const calculation = await db.get('savedCalculations', calculationId);
        if (!calculation) return alert('Calcolo salvato non trovato.');

        const printableContent = `
            <div class="p-6">
                <h1 class="text-2xl font-bold mb-4">${calculation.name}</h1>
                <p class="text-lg mb-4">Calcolo per ${calculation.adults} Adulti, ${calculation.children} Bambini per ${calculation.days} giorni | Scenario: ${calculation.scenario}</p>
                <h2 class="text-xl font-semibold mt-4 mb-2">Risultato Calcolo Scorte</h2> ${calculation.resultHTML} </div>
        `;

        const printableArea = document.getElementById('printableArea');
        printableArea.innerHTML = printableContent;

        window.print();

        // Pulire l'area di stampa dopo un breve ritardo
        setTimeout(() => {
             printableArea.innerHTML = '';
        }, 1000);
    }


    async function printList(listId) {
        const db = await dbPromise;
        const list = await db.get('lists', listId);
        if (!list) return alert('Lista non trovata.');

        const items = await db.getAllFromIndex('items', 'listId', listId);

        let printableContent = `
            <div class="p-6">
                <h1 class="text-2xl font-bold mb-4">${list.name} - ${list.scenario}</h1>
        `;

        if (list.type === 'outbag') {
             printableContent += `<p class="text-lg mb-4">Out-Bag per ${list.adults} Adulti, ${list.children} Bambini</p>`;
        }

        if (items.length > 0) {
            printableContent += `
                <h2 class="text-xl font-semibold mb-2">Articoli nella Lista</h2> <table>
                    <thead>
                        <tr>
                            <th>Voce</th>
                            <th>Quantità</th>
                            <th>Data Inserimento</th>
                            <th>Scadenza</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.forEach(item => {
                printableContent += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${dayjs(item.insertDate).format('DD/MM/YYYY')}</td>
                        <td>${item.expiration ? dayjs(item.expiration).format('DD/MM/YYYY') : '-'}</td>
                    </tr>
                `;
            });
            printableContent += `
                    </tbody>
                </table>
            `;
        } else {
            printableContent += "<p>Nessun articolo in questa lista.</p>";
        }

        printableContent += `</div>`; // Chiudi il div principale

        const printableArea = document.getElementById('printableArea');
        printableArea.innerHTML = printableContent;

        window.print();

        // Pulire l'area di stampa dopo un breve ritardo (per permettere al browser di avviare la stampa)
        setTimeout(() => {
             printableArea.innerHTML = '';
        }, 1000); // 1 secondo di ritardo
    }


    async function handleFileUpload(e) {
      for (const file of e.target.files) {
        const buf = await file.arrayBuffer();
        await (await dbPromise).add('files', { name: file.name, type: file.type, data: buf });
      }
      loadFiles(); e.target.value = '';
    }

    async function loadFiles() {
      const container = document.getElementById('files'); container.innerHTML = '';
      const files = await (await dbPromise).getAll('files');
      for (const file of files) {
        const blob = new Blob([file.data], { type: file.type });
        const url = URL.createObjectURL(blob);
        const div = document.createElement('div'); div.className = 'flex items-center';
        const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.textContent = file.name; a.className = 'underline';
        const btn = document.createElement('button'); btn.textContent = 'Elimina'; btn.className = 'ml-2 px-2 py-1 bg-red-600 text-white rounded text-sm';
        btn.addEventListener('click', async () => {
             if(confirm('Eliminare questo file?')) { // Conferma eliminazione
                await (await dbPromise).delete('files', file.id); loadFiles();
             }
        });
        div.append(a, btn);
        container.appendChild(div);
      }
    }

    // Funzioni per la nuova colonna delle scorte mediche
    function initMedicalSuppliesDropdown() {
        const selectElement = document.getElementById('medicalConditionSelect');
        // Popola il dropdown con le condizioni mediche
        for (const condition in commonMedicalSupplies) {
            const option = document.createElement('option');
            option.value = condition;
            option.textContent = condition;
            selectElement.appendChild(option);
        }
         // Imposta la visualizzazione iniziale
         displayMedicalSupplies();
    }

    function displayMedicalSupplies() {
        const selectElement = document.getElementById('medicalConditionSelect');
        const resultElement = document.getElementById('medicalSuppliesResult');
        const selectedCondition = selectElement.value;

        const supplies = commonMedicalSupplies[selectedCondition];

        if (supplies && supplies.length > 0) {
            let html = '<h4 class="font-semibold mb-2">Scorte consigliate:</h4><ul>';
            supplies.forEach(supply => {
                html += `<li>${supply}</li>`;
            });
            html += '</ul>';
            resultElement.innerHTML = html;
        } else {
            resultElement.innerHTML = '<p>Seleziona un sintomo dall\'elenco per vedere le scorte consigliate.</p>';
        }
    }


    window.addEventListener('load', async () => {
      await initDB();
      renderHeader();
      renderUI();
    });
  </script>
</body>
</html>